<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>Run Attendance</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Run Attendance">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --surface-light: #1f3056;
      --text: #e8e8e8;
      --text-muted: #8892a4;
      --present: #4ecca3;
      --present-bg: rgba(78, 204, 163, 0.15);
      --absent: #e74c3c;
      --absent-bg: rgba(231, 76, 60, 0.15);
      --neutral-border: #2a3a5c;
      --radius: 12px;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f0f2f5;
        --surface: #ffffff;
        --surface-light: #e8ecf1;
        --text: #1a1a2e;
        --text-muted: #6b7280;
        --neutral-border: #d1d5db;
        --present-bg: rgba(78, 204, 163, 0.2);
        --absent-bg: rgba(231, 76, 60, 0.15);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .view { display: none; }
    .view.active { display: flex; flex-direction: column; min-height: 100vh; min-height: 100dvh; }

    /* ===== HEADER ===== */
    header {
      background: var(--surface);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--neutral-border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      font-size: 18px;
      font-weight: 600;
    }

    header .date {
      font-size: 13px;
      color: var(--text-muted);
    }

    .gear-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      padding: 8px;
      cursor: pointer;
      border-radius: 8px;
    }

    .gear-btn:active { background: var(--surface-light); }

    /* ===== SETUP VIEW ===== */
    #setup-view {
      justify-content: center;
      padding: 24px;
    }

    .setup-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 28px 24px;
    }

    .setup-card h1 {
      font-size: 22px;
      margin-bottom: 4px;
    }

    .setup-card .subtitle {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 24px;
    }

    .field {
      margin-bottom: 18px;
    }

    .field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .field input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg);
      border: 1px solid var(--neutral-border);
      border-radius: 8px;
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
    }

    .field input:focus {
      outline: none;
      border-color: var(--present);
    }

    .field .hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: var(--radius);
      font-size: 17px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn:active { opacity: 0.8; }
    .btn:disabled { opacity: 0.4; cursor: default; }

    .btn-primary {
      background: var(--present);
      color: #1a1a2e;
    }

    .btn-secondary {
      background: var(--surface-light);
      color: var(--text);
      margin-top: 10px;
    }

    .btn-send {
      background: #007aff;
      color: white;
    }

    .status-msg {
      text-align: center;
      padding: 12px;
      font-size: 14px;
      border-radius: 8px;
      margin-top: 16px;
      display: none;
    }

    .status-msg.error {
      display: block;
      background: var(--absent-bg);
      color: var(--absent);
    }

    .status-msg.loading {
      display: block;
      background: var(--present-bg);
      color: var(--present);
    }

    /* ===== ATTENDANCE VIEW ===== */
    .runner-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 16px;
      flex: 1;
      align-content: start;
    }

    .runner-card {
      background: var(--surface);
      border: 2px solid var(--neutral-border);
      border-radius: var(--radius);
      padding: 14px 10px;
      text-align: center;
      transition: border-color 0.2s, background 0.2s;
    }

    .runner-card.present {
      border-color: var(--present);
      background: var(--present-bg);
    }

    .runner-card.absent {
      border-color: var(--absent);
      background: var(--absent-bg);
    }

    .runner-card.absent .runner-photo {
      opacity: 0.5;
    }

    .runner-photo {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 8px;
      background: var(--surface-light);
      transition: opacity 0.2s;
    }

    .runner-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      line-height: 1.2;
    }

    .runner-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
      line-height: 1.3;
      max-height: 28px;
      overflow: hidden;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .card-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid var(--neutral-border);
      background: var(--bg);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .card-btn:active { transform: scale(0.9); }

    .card-btn.yes-btn.selected {
      background: var(--present);
      border-color: var(--present);
      color: white;
    }

    .card-btn.no-btn.selected {
      background: var(--absent);
      border-color: var(--absent);
      color: white;
    }

    /* ===== FOOTER ===== */
    .footer {
      background: var(--surface);
      border-top: 1px solid var(--neutral-border);
      padding: 12px 20px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      position: sticky;
      bottom: 0;
    }

    .progress-text {
      text-align: center;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    /* ===== CONFIRM VIEW ===== */
    #confirm-view {
      padding: 0;
    }

    .confirm-content {
      padding: 20px;
      flex: 1;
    }

    .confirm-section {
      margin-bottom: 20px;
    }

    .confirm-section h3 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      color: var(--text-muted);
    }

    .confirm-section h3.present-label { color: var(--present); }
    .confirm-section h3.absent-label { color: var(--absent); }

    .confirm-list {
      list-style: none;
    }

    .confirm-list li {
      padding: 8px 0;
      font-size: 16px;
      border-bottom: 1px solid var(--neutral-border);
    }

    .confirm-list li:last-child { border-bottom: none; }

    .confirm-buttons {
      padding: 16px 20px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      background: var(--surface);
      border-top: 1px solid var(--neutral-border);
    }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }

    .empty-state p {
      font-size: 16px;
      margin-bottom: 16px;
    }

    /* ===== MARK ALL BAR ===== */
    .mark-all-bar {
      display: flex;
      gap: 8px;
      padding: 10px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--neutral-border);
    }

    .mark-all-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--neutral-border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
    }

    .mark-all-btn:active { opacity: 0.7; }
  </style>
</head>
<body>

  <!-- ===== SETUP VIEW ===== -->
  <div id="setup-view" class="view active">
    <div class="setup-card">
      <h1>Run Attendance</h1>
      <p class="subtitle">Back on My Feet - Wednesday Run</p>

      <div class="field">
        <label>Slack Bot Token</label>
        <input type="password" id="input-token" placeholder="xoxb-..." autocomplete="off">
        <p class="hint">From your Slack app's OAuth page</p>
      </div>

      <div class="field">
        <label>Slack Channel ID</label>
        <input type="text" id="input-channel" placeholder="C0XXXXXXX" autocomplete="off">
        <p class="hint">Channel with "Please welcome" posts. Right-click > View details > ID at bottom</p>
      </div>

      <div class="field">
        <label>Program Director's Phone</label>
        <input type="tel" id="input-phone" placeholder="+1XXXXXXXXXX">
        <p class="hint">Include country code for iMessage</p>
      </div>

      <button class="btn btn-primary" id="btn-connect" onclick="connectAndLoad()">
        Connect &amp; Load Roster
      </button>

      <div class="status-msg" id="setup-status"></div>
    </div>
  </div>

  <!-- ===== ATTENDANCE VIEW ===== -->
  <div id="attendance-view" class="view">
    <header>
      <div>
        <h1>Wednesday Run</h1>
        <div class="date" id="run-date"></div>
      </div>
      <button class="gear-btn" onclick="showSettings()" aria-label="Settings">&#9881;</button>
    </header>

    <div class="mark-all-bar">
      <button class="mark-all-btn" onclick="markAll('present')">All Present</button>
      <button class="mark-all-btn" onclick="markAll('absent')">All Absent</button>
      <button class="mark-all-btn" onclick="markAll('clear')">Clear All</button>
    </div>

    <div class="runner-grid" id="runner-grid"></div>

    <div class="footer">
      <div class="progress-text" id="progress-text">0 of 0 marked</div>
      <button class="btn btn-primary" id="btn-send" onclick="showConfirmation()" disabled>
        Send Attendance
      </button>
    </div>
  </div>

  <!-- ===== CONFIRM VIEW ===== -->
  <div id="confirm-view" class="view">
    <header>
      <div>
        <h1>Confirm Attendance</h1>
        <div class="date" id="confirm-date"></div>
      </div>
    </header>

    <div class="confirm-content" id="confirm-content"></div>

    <div class="confirm-buttons">
      <button class="btn btn-send" onclick="sendViaIMessage()">Send via iMessage</button>
      <button class="btn btn-secondary" onclick="showView('attendance-view')">Back</button>
    </div>
  </div>

  <!-- ===== SETTINGS OVERLAY ===== -->
  <div id="settings-view" class="view">
    <div class="setup-card" style="margin: 24px; margin-top: calc(24px + env(safe-area-inset-top));">
      <h1>Settings</h1>
      <p class="subtitle">Update your configuration</p>

      <div class="field">
        <label>Slack Bot Token</label>
        <input type="password" id="settings-token" placeholder="xoxb-..." autocomplete="off">
      </div>

      <div class="field">
        <label>Slack Channel ID</label>
        <input type="text" id="settings-channel" placeholder="C0XXXXXXX" autocomplete="off">
      </div>

      <div class="field">
        <label>Program Director's Phone</label>
        <input type="tel" id="settings-phone" placeholder="+1XXXXXXXXXX">
      </div>

      <button class="btn btn-primary" onclick="refreshRoster()">Refresh Roster from Slack</button>
      <button class="btn btn-secondary" onclick="saveSettingsAndClose()">Save &amp; Close</button>
      <button class="btn btn-secondary" onclick="showView('attendance-view')" style="margin-top: 4px;">Cancel</button>

      <div class="status-msg" id="settings-status"></div>
    </div>
  </div>

<script>

// ===== STATE =====
let runners = [];
let config = {};

// ===== INIT =====
function initApp() {
  config = JSON.parse(localStorage.getItem('bomf_config') || '{}');
  const roster = JSON.parse(localStorage.getItem('bomf_roster') || '{}');

  if (config.token && config.channel && roster.runners && roster.runners.length > 0) {
    runners = roster.runners.map(r => ({ ...r, status: null }));
    showAttendanceView();
  } else if (config.token) {
    // Has config but no roster — show setup with values pre-filled
    document.getElementById('input-token').value = config.token || '';
    document.getElementById('input-channel').value = config.channel || '';
    document.getElementById('input-phone').value = config.phone || '';
    showView('setup-view');
  } else {
    showView('setup-view');
  }
}

// ===== VIEWS =====
function showView(viewId) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(viewId).classList.add('active');
}

function showAttendanceView() {
  const today = new Date().toLocaleDateString('en-US', {
    weekday: 'long', month: 'short', day: 'numeric', year: 'numeric'
  });
  document.getElementById('run-date').textContent = today;
  renderCards();
  showView('attendance-view');
}

function showSettings() {
  document.getElementById('settings-token').value = config.token || '';
  document.getElementById('settings-channel').value = config.channel || '';
  document.getElementById('settings-phone').value = config.phone || '';
  document.getElementById('settings-status').className = 'status-msg';
  document.getElementById('settings-status').textContent = '';
  showView('settings-view');
}

function saveSettingsAndClose() {
  config.token = document.getElementById('settings-token').value.trim();
  config.channel = document.getElementById('settings-channel').value.trim();
  config.phone = document.getElementById('settings-phone').value.trim();
  localStorage.setItem('bomf_config', JSON.stringify(config));
  showView('attendance-view');
}

// ===== SLACK API =====
async function slackPost(method, params) {
  const body = new URLSearchParams({ token: config.token, ...params });
  const resp = await fetch(`https://slack.com/api/${method}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body.toString()
  });
  return resp.json();
}

async function fetchRoster(statusEl) {
  statusEl.className = 'status-msg loading';
  statusEl.textContent = 'Reading channel messages...';

  // We read messages from the channel looking for "Please welcome" posts
  // that contain a member's name and attached photo.
  // Only look at the last year of posts (program is 1 year long).
  const oneYearAgo = Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60);

  const rosterData = [];
  let cursor = undefined;
  let pageNum = 0;

  // Paginate through channel history
  while (true) {
    pageNum++;
    statusEl.textContent = `Reading messages (page ${pageNum})...`;

    const params = {
      channel: config.channel,
      limit: '100',
      oldest: String(oneYearAgo)
    };
    if (cursor) params.cursor = cursor;

    const histResp = await slackPost('conversations.history', params);
    if (!histResp.ok) {
      throw new Error(histResp.error || 'Failed to read channel messages');
    }

    const messages = histResp.messages || [];

    for (const msg of messages) {
      // Look for "Please welcome" pattern in the message text
      const text = msg.text || '';
      const welcomeMatch = text.match(/[Pp]lease\s+[Ww]elcome\s+(.+?)[\s]*[.!,\n\r]/);
      if (!welcomeMatch) continue;

      // Extract the name — clean up any Slack formatting
      let name = welcomeMatch[1].trim();
      // Remove Slack bold markers, links, etc.
      name = name.replace(/[*_~`]/g, '').trim();
      // Remove "to the team" or similar trailing phrases
      name = name.replace(/\s+to\s+(the|our|BoMF|Back on My Feet).*/i, '').trim();

      if (!name || name.length < 2) continue;

      // Look for an attached photo (image file)
      let photoDataUrl = '';
      const files = msg.files || [];
      const imageFile = files.find(f =>
        f.mimetype && f.mimetype.startsWith('image/')
      );

      if (imageFile) {
        // Use the thumbnail URL (smaller, faster to cache)
        // Slack private URLs need the token as an auth header
        const photoUrl = imageFile.thumb_360 || imageFile.thumb_160 || imageFile.url_private;
        if (photoUrl) {
          try {
            statusEl.textContent = `Loading photo for ${name}...`;
            photoDataUrl = await fetchSlackImage(photoUrl);
          } catch (e) {
            // Photo failed — member will show without photo
            console.log('Photo fetch failed for', name, e);
          }
        }
      }

      // Also capture the description (rest of the message after the name)
      let description = '';
      const afterName = text.substring(text.indexOf(name) + name.length);
      if (afterName) {
        description = afterName.replace(/^[\s.!,\-–—:]+/, '').trim();
        // Keep just the first sentence or two
        const sentences = description.split(/[.!]\s/);
        description = sentences.slice(0, 2).join('. ').trim();
        if (description && !description.endsWith('.')) description += '.';
      }

      rosterData.push({
        name: name,
        photoDataUrl: photoDataUrl,
        description: description,
        messageTs: msg.ts  // timestamp for deduplication
      });
    }

    // Check if there are more pages
    if (histResp.has_more && histResp.response_metadata && histResp.response_metadata.next_cursor) {
      cursor = histResp.response_metadata.next_cursor;
    } else {
      break;
    }
  }

  // Deduplicate by name (keep the most recent post for each person)
  const seen = new Map();
  for (const r of rosterData) {
    const key = r.name.toLowerCase();
    if (!seen.has(key) || parseFloat(r.messageTs) > parseFloat(seen.get(key).messageTs)) {
      seen.set(key, r);
    }
  }
  const dedupedRoster = Array.from(seen.values());

  // Sort alphabetically by first name
  dedupedRoster.sort((a, b) => a.name.localeCompare(b.name));

  statusEl.textContent = `Found ${dedupedRoster.length} members!`;

  // Save to localStorage
  const roster = {
    lastUpdated: new Date().toISOString(),
    runners: dedupedRoster
  };
  localStorage.setItem('bomf_roster', JSON.stringify(roster));

  return dedupedRoster;
}

// Fetch a Slack-hosted image using the bot token for auth
async function fetchSlackImage(url) {
  const resp = await fetch(url, {
    headers: { 'Authorization': 'Bearer ' + config.token }
  });
  if (!resp.ok) throw new Error('Image fetch failed');
  const blob = await resp.blob();
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

function imageToBase64(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = 144;
      canvas.height = 144;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, 144, 144);
      resolve(canvas.toDataURL('image/jpeg', 0.7));
    };
    img.onerror = reject;
    img.src = url;
  });
}

// ===== CONNECT =====
async function connectAndLoad() {
  const token = document.getElementById('input-token').value.trim();
  const channel = document.getElementById('input-channel').value.trim();
  const phone = document.getElementById('input-phone').value.trim();

  if (!token || !channel) {
    setStatus('setup-status', 'error', 'Please enter both the token and channel ID.');
    return;
  }

  config = { token, channel, phone };
  localStorage.setItem('bomf_config', JSON.stringify(config));

  const statusEl = document.getElementById('setup-status');
  const btn = document.getElementById('btn-connect');
  btn.disabled = true;

  try {
    const rosterData = await fetchRoster(statusEl);
    if (rosterData.length === 0) {
      setStatus('setup-status', 'error', 'No members found in that channel. Check the channel ID.');
      btn.disabled = false;
      return;
    }

    runners = rosterData.map(r => ({ ...r, status: null }));
    showAttendanceView();
  } catch (err) {
    setStatus('setup-status', 'error', 'Error: ' + err.message);
    btn.disabled = false;
  }
}

async function refreshRoster() {
  const statusEl = document.getElementById('settings-status');
  config.token = document.getElementById('settings-token').value.trim();
  config.channel = document.getElementById('settings-channel').value.trim();
  config.phone = document.getElementById('settings-phone').value.trim();
  localStorage.setItem('bomf_config', JSON.stringify(config));

  try {
    const rosterData = await fetchRoster(statusEl);
    if (rosterData.length === 0) {
      setStatus('settings-status', 'error', 'No members found. Check channel ID.');
      return;
    }
    runners = rosterData.map(r => ({ ...r, status: null }));
    setStatus('settings-status', 'loading', `Loaded ${runners.length} runners!`);
    setTimeout(() => {
      showAttendanceView();
    }, 1000);
  } catch (err) {
    setStatus('settings-status', 'error', 'Error: ' + err.message);
  }
}

function setStatus(elId, type, msg) {
  const el = document.getElementById(elId);
  el.className = 'status-msg ' + type;
  el.textContent = msg;
}

// ===== RENDER CARDS =====
function renderCards() {
  const grid = document.getElementById('runner-grid');

  if (runners.length === 0) {
    grid.innerHTML = '<div class="empty-state"><p>No runners loaded yet.</p><p>Tap the gear icon to set up Slack connection.</p></div>';
    return;
  }

  grid.innerHTML = runners.map((r, i) => `
    <div class="runner-card ${r.status || ''}" id="card-${i}">
      <img class="runner-photo" src="${r.photoDataUrl || ''}" alt="${r.name}"
           onerror="this.style.background='var(--surface-light)'; this.alt='No photo';">
      <div class="runner-name">${escapeHtml(r.name)}</div>
      <div class="runner-desc">${r.description ? escapeHtml(r.description) : ''}</div>
      <div class="card-actions">
        <button class="card-btn yes-btn ${r.status === 'present' ? 'selected' : ''}"
                onclick="toggleStatus(${i}, 'present')" aria-label="Present">&#10003;</button>
        <button class="card-btn no-btn ${r.status === 'absent' ? 'selected' : ''}"
                onclick="toggleStatus(${i}, 'absent')" aria-label="Absent">&#10007;</button>
      </div>
    </div>
  `).join('');

  updateProgress();
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ===== TOGGLE STATUS =====
function toggleStatus(index, status) {
  const runner = runners[index];

  // If already this status, deselect
  if (runner.status === status) {
    runner.status = null;
  } else {
    runner.status = status;
  }

  // Update card UI without full re-render
  const card = document.getElementById(`card-${index}`);
  card.className = `runner-card ${runner.status || ''}`;

  const yesBtn = card.querySelector('.yes-btn');
  const noBtn = card.querySelector('.no-btn');
  yesBtn.className = `card-btn yes-btn ${runner.status === 'present' ? 'selected' : ''}`;
  noBtn.className = `card-btn no-btn ${runner.status === 'absent' ? 'selected' : ''}`;

  updateProgress();
}

function markAll(status) {
  runners.forEach((r, i) => {
    if (status === 'clear') {
      r.status = null;
    } else {
      r.status = status;
    }
  });
  renderCards();
}

function updateProgress() {
  const marked = runners.filter(r => r.status !== null).length;
  const total = runners.length;
  document.getElementById('progress-text').textContent = `${marked} of ${total} marked`;
  document.getElementById('btn-send').disabled = marked < total;
}

// ===== CONFIRMATION =====
function showConfirmation() {
  const today = new Date().toLocaleDateString('en-US', {
    weekday: 'long', month: 'short', day: 'numeric', year: 'numeric'
  });
  document.getElementById('confirm-date').textContent = today;

  const present = runners.filter(r => r.status === 'present');
  const absent = runners.filter(r => r.status === 'absent');

  let html = '';

  if (present.length > 0) {
    html += `<div class="confirm-section">
      <h3 class="present-label">Present (${present.length})</h3>
      <ul class="confirm-list">
        ${present.map(r => `<li>${escapeHtml(r.name)}</li>`).join('')}
      </ul>
    </div>`;
  }

  if (absent.length > 0) {
    html += `<div class="confirm-section">
      <h3 class="absent-label">Absent (${absent.length})</h3>
      <ul class="confirm-list">
        ${absent.map(r => `<li>${escapeHtml(r.name)}</li>`).join('')}
      </ul>
    </div>`;
  }

  document.getElementById('confirm-content').innerHTML = html;
  showView('confirm-view');
}

// ===== SEND VIA IMESSAGE =====
function sendViaIMessage() {
  const present = runners.filter(r => r.status === 'present').map(r => r.name);
  const absent = runners.filter(r => r.status === 'absent').map(r => r.name);

  const date = new Date().toLocaleDateString('en-US', {
    weekday: 'long', month: 'short', day: 'numeric', year: 'numeric'
  });

  let message = `Wednesday Run - ${date}\n\n`;
  message += `Present (${present.length}):\n`;
  present.forEach(name => { message += `- ${name}\n`; });

  if (absent.length > 0) {
    message += `\nAbsent (${absent.length}):\n`;
    absent.forEach(name => { message += `- ${name}\n`; });
  }

  const phone = config.phone || '';
  const encoded = encodeURIComponent(message);

  // iOS uses & separator (not ?) for sms: body parameter
  window.location.href = `sms:${phone}&body=${encoded}`;
}

// ===== SERVICE WORKER =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// ===== START =====
initApp();

</script>
</body>
</html>
